<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Casino</title>
 <style>
   * {
     margin: 0;
     padding: 0;
     box-sizing: border-box;
   }

   body {
     font-family: Arial, sans-serif;
     /* Шлях до шпалер - правильний, згідно з вашим скріншотом */
     background-image: url('./wallpaper.jpg');
     background-size: cover;
     display: flex;
     justify-content: center;
     align-items: center;
     height: 100vh;
     color: white;
     text-align: center;
   }

   p, span {
     margin-block:15px;
   }

   .game-container {
     padding: 20px;
     border: 2px solid #fff;
     border-radius: 10px;
     background: rgba(0, 0, 0, 0.5);
   }

   .container {
     display: flex;
     flex-direction: column;
     gap: 20px;
     margin: 20px 0;
   }

   .row {
     display: flex;
     justify-content: center;
     gap: 10px;
   }

   .item {
     width: 100px;
     height: 100px;
     background-size: contain;
     background-repeat: no-repeat;
     background-color: #333;
     border: 2px solid #fff;
     border-radius: 5px;
     transition: transform 0.3s ease, box-shadow 0.3s ease;
   }

   button {
     padding: 10px 20px;
     background-color: #008CBA;
     color: white;
     border: none;
     font-size: 16px;
     cursor: pointer;
     margin: 10px 0;
   }

   button:hover {
     background-color: #005f73;
   }

   .text-container {
     display: flex;
     flex-direction: column;
     justify-content: center;
   }

   h1, h2 {
     margin-bottom: 20px;
   }

   #resultMessage {
     color: yellow;
     font-size: 24px;
     font-weight: bold;
   }

   @media (max-width: 600px) {
     .item {
       width: 70px;
       height: 70px;
     }
   }

   .highlight {
     border: 3px solid #ffcc00;
     animation: highlightAnimation 0.5s ease-in-out;
   }

   @keyframes highlightAnimation {
     0% {
       background-color: rgba(255, 255, 0, 0.2);
     }
     50% {
       background-color: rgba(255, 255, 0, 0.5);
     }
     100% {
       background-color: rgba(255, 255, 0, 0.2);
     }
   }
 </style>

</head>
<body>
 
 <div class="game-container">
   <h1>Hello, <span id="playerName"></span>!</h1>
   <span id="attemptCount">Attempts: 0</span></p>
   <div class="container">
     <div class="row">
       <div class="item"></div>
       <div class="item"></div>
       <div class="item"></div>
     </div>
     <div class="row">
       <div class="item"></div>
       <div class="item"></div>
       <div class="item"></div>
     </div>
     <div class="row">
       <div class="item"></div>
       <div class="item"></div>
       <div class="item"></div>
     </div>
   </div>
   <div class="text-container">
     <p id="resultMessage"></p>
     <button id="startGameButton">Play</button>
     <button id="restartGameButton" style="display: none;">Restart</button>
   </div>
 </div>

 <script>
   let playerName = prompt("Enter your name:");
   if (!playerName) {
     playerName = "Player";
   }

   document.getElementById("playerName").textContent = playerName;

   // ❗️ ВАЖЛИВО: Шляхи виправлено (без папки 'icon/')
   const images = [
     './apple.png',
     './bananas.png',
     './strawberry.png',
     './cherries.png',
     './orange.png'
   ];

   let attempts = 0;
   let gameOver = attempts >= 3 ? true : false;

   document.getElementById('startGameButton').addEventListener('click', startGame);
   document.getElementById('restartGameButton').addEventListener('click', restartGame);

   function getRandomImage(excludeImages = []) {
     const filteredImages = images.filter(image => !excludeImages.includes(image));
     const randomIndex = Math.floor(Math.random() * filteredImages.length);
     return filteredImages[randomIndex];
   }

   /**
    * Анімує одну комірку, змушуючи її мерехтіти, 
    * а потім зупиняється на фінальній картинці.
    */
   function spinCell(item, finalImage, duration) {
     // Повертаємо Promise, щоб функція startGame могла "чекати"
     return new Promise(resolve => {
       
       // Починаємо мерехтіння: міняємо картинку кожні 50мс
       const flickerInterval = setInterval(() => {
         // Беремо абсолютно випадкову картинку для анімації
         const randomFlickerImage = images[Math.floor(Math.random() * images.length)];
         item.style.backgroundImage = `url(${randomFlickerImage})`;
       }, 50); // Інтервал мерехтіння

       // Встановлюємо таймер, щоб зупинити обертання
       setTimeout(() => {
         clearInterval(flickerInterval); // Зупиняємо мерехтіння
         item.style.backgroundImage = `url(${finalImage})`; // Встановлюємо фінальну картинку
         resolve(); // Повідомляємо, що анімація завершена
       }, duration); // 'duration' - це час, який ми розрахували в startGame
     });
   }

   // ❗️ НОВА АСИНХРОННА функція startGame
   async function startGame() { // Додаємо 'async', щоб мати змогу чекати
     if (attempts >= 3) {
       gameOver = true;
     }

     if (gameOver) {
       document.getElementById('resultMessage').textContent = 'You have used all attempts. Click Restart';
       document.getElementById('restartGameButton').style.display = 'block';
       document.getElementById('startGameButton').style.display = 'none';
     } else {
       attempts++;
       document.getElementById('attemptCount').textContent = `Attempts: ${attempts}`
       
       // Блокуємо кнопку "Play" на час обертання
       document.getElementById('startGameButton').disabled = true;
       // Очищуємо старі результати та підсвічування
       document.getElementById('resultMessage').textContent = '';
       document.querySelectorAll('.item').forEach(item => item.classList.remove('highlight'));

       const rows = document.querySelectorAll('.row');
       const finalGrid = []; // Тут збережемо фінальні результати
       const columnImages = [[], [], []];

       // 1. Спочатку ВИЗНАЧАЄМО, які картинки випадуть (але ще не показуємо)
       rows.forEach((row, rowIndex) => {
         finalGrid[rowIndex] = [];
         const items = row.querySelectorAll('.item');
         items.forEach((item, colIndex) => {
           const usedImages = columnImages[colIndex];
           const randomImage = getRandomImage(usedImages);
           usedImages.push(randomImage);
           finalGrid[rowIndex][colIndex] = randomImage; // Зберігаємо фінальну картинку
         });
       });

       // 2. Створюємо список "обіцянок" (Promise) для анімації
       const spinPromises = [];
       let baseDuration = 1000; // Базовий час обертання (1 сек)
       let reelStagger = 400;  // Затримка між зупинкою стовпців (мілісекунди)
       let rowStagger = 100;   // Невелика затримка між комірками в одному стовпці

       rows.forEach((row, rowIndex) => {
         const items = row.querySelectorAll('.item');
         items.forEach((item, colIndex) => {
           const finalImage = finalGrid[rowIndex][colIndex];
           // Чим правіше стовпець, тим довше він крутиться
           const stopTime = baseDuration + (colIndex * reelStagger) + (rowIndex * rowStagger);
           
           // Додаємо анімацію обертання до списку
           spinPromises.push(spinCell(item, finalImage, stopTime));
         });
       });

       // 3. ЧЕКАЄМО, поки ВСІ анімації завершаться
       await Promise.all(spinPromises);

       // 4. Тільки тепер перевіряємо виграш
       checkWin(rows);
       
       // 5. Розблоковуємо кнопку "Play", ЯКЩО не було виграшу
       // (Якщо був виграш, checkWin покаже кнопку "Restart")
       if (document.getElementById('resultMessage').textContent === '') {
          document.getElementById('startGameButton').disabled = false;
       }
     }
   }

   function checkWin(rows) {
     for (const row of rows) {
       const items = row.querySelectorAll('.item');
       const firstImage = items[0].style.backgroundImage;

       const allSame = Array.from(items).every(item => item.style.backgroundImage === firstImage);

       if (allSame && firstImage !== "") {
         document.getElementById('resultMessage').textContent = `${playerName}, you won!`;
         document.getElementById('restartGameButton').style.display = 'block';
         document.getElementById('startGameButton').style.display = 'none';
         highlightWinningCells();
       }
     }
   }

   function highlightWinningCells() {
     const rows = document.querySelectorAll('.row');
     rows.forEach(row => {
       const items = row.querySelectorAll('.item');
       const firstImage = items[0].style.backgroundImage;
       const allSame = Array.from(items).every(item => item.style.backgroundImage === firstImage);

       if (allSame && firstImage !== "") {
         items.forEach(item => {
           item.classList.add('highlight');
         });
       }
     });
   }

   function restartGame() {
     gameOver = false;
     attempts = 0;
     document.getElementById('attemptCount').textContent = `Attempts: ${attempts}`;
     document.getElementById('startGameButton').disabled = false;
     document.getElementById('startGameButton').style.display = 'block';
     document.getElementById('resultMessage').textContent = '';
     document.getElementById('restartGameButton').style.display = 'none';
     clearBoard();
   }

   function clearBoard() {
     const rows = document.querySelectorAll('.row');
     rows.forEach(row => {
       const items = row.querySelectorAll('.item');
       items.forEach(item => {
         item.style.backgroundImage = '';
         item.classList.remove('highlight');
       });
     });
   }
 </script>

</body>
</html>